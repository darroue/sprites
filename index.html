<!DOCTYPE html>
<html lang="cs">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Interaktivní aplikace s poskakujícími sprites">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Bobíci">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="sprites/bee.png">
  <title>Bobíci</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: Arial, sans-serif;
    }

    canvas {
      display: block;
      background: rgba(255, 255, 255, 0.1);
    }

    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <canvas id="canvas"></canvas>
  <div id="info">
    Chyťte a hoďte sprite! Krátký dotyk přidá nový sprite.<br>
    Počet sprites: <span id="count">0</span>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const countDisplay = document.getElementById('count');

    // Nastavení velikosti canvasu
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Gravitace ovládaná nakloněním telefonu
    let gravityX = 0; // Horizontální gravitace
    let gravityY = 0.3; // Vertikální gravitace

    // Seznam všech sprites
    const spriteFiles = [
      'bee.png',
      'cactus.png',
      'cat.png',
      'chameleon.png',
      'chocolate.png',
      'flower.png',
      'ice_cream.png',
      'lemon.png',
      'rasberry.png',
      'snail.png',
      'sponge_bob.png',
      'sushi.png',
      'toast.png',
      'whale.png'
    ];

    // Načtení obrázků
    const images = [];
    let loadedImages = 0;

    spriteFiles.forEach(file => {
      const img = new Image();
      img.src = `sprites/${file}`;
      img.onload = () => {
        loadedImages++;
        if (loadedImages === spriteFiles.length) {
          init();
        }
      };
      images.push(img);
    });

    // Třída pro každý sprite
    class Sprite {
      constructor(x, y, image) {
        this.image = image;
        this.size = 50 + Math.random() * 50; // Velikost 50-100px
        this.x = x !== undefined ? x : Math.random() * (canvas.width - this.size);
        this.y = y !== undefined ? y : Math.random() * (canvas.height - this.size);

        // Pohyb
        this.speedX = (Math.random() - 0.5) * 3;
        this.speedY = (Math.random() - 0.5) * 3;

        // Poskakování
        this.jumpSpeed = 0;
        this.onGround = false;
        this.bounceCount = 0;
        this.maxBounces = 5 + Math.floor(Math.random() * 3); // 5-7 odrazů
        this.isWalking = false;
        this.walkSpeed = 0.3 + Math.random() * 0.5; // Rychlost chůze
        this.stuckToSide = null; // 'top', 'bottom', 'left', 'right' - strana, na které stojí

        // Animace
        this.rotation = Math.random() * Math.PI * 2;
        this.rotationSpeed = (Math.random() - 0.5) * 0.1;
        this.scale = 1;
        this.scaleDirection = 1;
        this.scaleSpeed = 0.01;

        // Chytání
        this.isDragging = false;
        this.dragOffsetX = 0;
        this.dragOffsetY = 0;
        this.lastVelocityX = 0;
        this.lastVelocityY = 0;
      }

      update() {
        // Pokud je chycený, neprovádí normální update
        if (this.isDragging) {
          return;
        }

        if (!this.isWalking) {
          // Režim poskakování

          // Aplikuj gravitaci podle naklonění
          this.speedX += gravityX;
          this.jumpSpeed += gravityY;

          this.x += this.speedX;
          this.y += this.jumpSpeed;

          // Tlumení rychlosti (odpor vzduchu)
          this.speedX *= 0.99;

          // Kontrola všech stran (kterákoliv může být "dno")
          let hitEdge = false;
          const bounceThreshold = 0.1; // Minimální rychlost pro odraz

          // Dolní strana
          if (this.y + this.size >= canvas.height && this.jumpSpeed > 0) {
            this.y = canvas.height - this.size;
            if (Math.abs(this.jumpSpeed) > bounceThreshold) {
              this.jumpSpeed *= -0.5; // Odraz
              this.bounceCount++;
            } else {
              this.jumpSpeed = 0;
              hitEdge = true;
              this.stuckToSide = 'bottom';
            }
          }

          // Horní strana
          if (this.y <= 0 && this.jumpSpeed < 0) {
            this.y = 0;
            if (Math.abs(this.jumpSpeed) > bounceThreshold) {
              this.jumpSpeed *= -0.5;
              this.bounceCount++;
            } else {
              this.jumpSpeed = 0;
              hitEdge = true;
              this.stuckToSide = 'top';
            }
          }

          // Levá strana
          if (this.x <= 0 && this.speedX < 0) {
            this.x = 0;
            if (Math.abs(this.speedX) > bounceThreshold) {
              this.speedX *= -0.5;
              this.bounceCount++;
            } else {
              this.speedX = 0;
              hitEdge = true;
              this.stuckToSide = 'left';
            }
          }

          // Pravá strana
          if (this.x + this.size >= canvas.width && this.speedX > 0) {
            this.x = canvas.width - this.size;
            if (Math.abs(this.speedX) > bounceThreshold) {
              this.speedX *= -0.5;
              this.bounceCount++;
            } else {
              this.speedX = 0;
              hitEdge = true;
              this.stuckToSide = 'right';
            }
          }

          // Přechod na chůzi po dosažení dostatečného počtu odrazů nebo pokud je neaktivní
          if (hitEdge && (Math.abs(this.speedX) < 0.1 && Math.abs(this.jumpSpeed) < 0.1)) {
            this.bounceCount++;
          }

          if (this.bounceCount >= this.maxBounces) {
            this.isWalking = true;
            this.jumpSpeed = 0;
            this.speedX = (Math.random() > 0.5 ? 1 : -1) * this.walkSpeed;
            this.rotationSpeed *= 0.1;
          }
        } else {
          // Režim chůze - drž sprite připoutaný ke straně, na které dopadl
          if (this.stuckToSide === 'bottom') {
            this.x += this.speedX;
            this.y = canvas.height - this.size;
            // Otočení při dosažení kraje
            if (this.x <= 0 || this.x + this.size >= canvas.width) {
              this.speedX *= -1;
              this.x = this.x <= 0 ? 0 : canvas.width - this.size;
            }
            // Mírné vertikální houpání při chůzi
            this.y -= Math.abs(Math.sin(Date.now() * 0.01 * this.walkSpeed)) * 3;
          } else if (this.stuckToSide === 'top') {
            this.x += this.speedX;
            this.y = 0;
            if (this.x <= 0 || this.x + this.size >= canvas.width) {
              this.speedX *= -1;
              this.x = this.x <= 0 ? 0 : canvas.width - this.size;
            }
            this.y += Math.abs(Math.sin(Date.now() * 0.01 * this.walkSpeed)) * 3;
          } else if (this.stuckToSide === 'left') {
            this.y += this.speedX; // Použij speedX pro vertikální pohyb
            this.x = 0;
            if (this.y <= 0 || this.y + this.size >= canvas.height) {
              this.speedX *= -1;
              this.y = this.y <= 0 ? 0 : canvas.height - this.size;
            }
            this.x += Math.abs(Math.sin(Date.now() * 0.01 * this.walkSpeed)) * 3;
          } else if (this.stuckToSide === 'right') {
            this.y += this.speedX;
            this.x = canvas.width - this.size;
            if (this.y <= 0 || this.y + this.size >= canvas.height) {
              this.speedX *= -1;
              this.y = this.y <= 0 ? 0 : canvas.height - this.size;
            }
            this.x -= Math.abs(Math.sin(Date.now() * 0.01 * this.walkSpeed)) * 3;
          }
        }

        // Rotace - pomalejší při chůzi
        if (this.isWalking) {
          this.rotation += this.rotationSpeed * 0.3;
        } else {
          this.rotation += this.rotationSpeed;
        }

        // Pulzující efekt - menší při chůzi
        if (this.isWalking) {
          this.scale += this.scaleSpeed * this.scaleDirection * 0.5;
          if (this.scale > 1.05 || this.scale < 0.95) {
            this.scaleDirection *= -1;
          }
        } else {
          this.scale += this.scaleSpeed * this.scaleDirection;
          if (this.scale > 1.1 || this.scale < 0.9) {
            this.scaleDirection *= -1;
          }
        }
      }

      contains(x, y) {
        return x >= this.x && x <= this.x + this.size &&
          y >= this.y && y <= this.y + this.size;
      }

      resetPhysics() {
        // Reset poskakování a zahájení nového cyklu
        this.isWalking = false;
        this.bounceCount = 0;
        this.onGround = false;
        this.stuckToSide = null;
      }

      draw() {
        ctx.save();

        // Přesun do středu sprite
        ctx.translate(this.x + this.size / 2, this.y + this.size / 2);

        // Aplikace transformací
        ctx.rotate(this.rotation);
        ctx.scale(this.scale, this.scale);

        // Stín
        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
        ctx.shadowBlur = 10;
        ctx.shadowOffsetX = 5;
        ctx.shadowOffsetY = 5;

        // Vykreslení obrázku
        ctx.drawImage(
          this.image,
          -this.size / 2,
          -this.size / 2,
          this.size,
          this.size
        );

        ctx.restore();
      }
    }

    const sprites = [];

    function init() {
      // Vytvoření počátečního sprite
      const randomImage = images[Math.floor(Math.random() * images.length)];
      sprites.push(new Sprite(canvas.width / 2 - 50, 50, randomImage));
      updateCount();
      animate();
    }

    function animate() {
      // Vyčištění canvasu
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Aktualizace a vykreslení všech sprites
      sprites.forEach(sprite => {
        sprite.update();
        sprite.draw();
      });

      requestAnimationFrame(animate);
    }

    function updateCount() {
      countDisplay.textContent = sprites.length;
    }

    // Drag and drop proměnné
    let draggedSprite = null;
    let mouseX = 0;
    let mouseY = 0;
    let isDraggingAny = false;
    let touchStartTime = 0;
    let touchStartPos = { x: 0, y: 0 };
    const LONG_PRESS_DURATION = 500; // 500ms pro dlouhý dotyk

    // Funkce pro získání pozice myši/dotyku
    function getMousePos(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches) {
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top
        };
      }
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }

    // Najdi sprite pod kurzorem (poslední = nahoře)
    function getSpriteAtPosition(x, y) {
      for (let i = sprites.length - 1; i >= 0; i--) {
        if (sprites[i].contains(x, y)) {
          return sprites[i];
        }
      }
      return null;
    }

    // Mouse/Touch start - chytnutí
    function handleStart(e) {
      e.preventDefault();
      const pos = getMousePos(e);
      mouseX = pos.x;
      mouseY = pos.y;

      // Zaznamenej čas a pozici pro detekci dlouhého dotyku
      touchStartTime = Date.now();
      touchStartPos = { x: mouseX, y: mouseY };

      const sprite = getSpriteAtPosition(mouseX, mouseY);
      if (sprite) {
        draggedSprite = sprite;
        draggedSprite.isDragging = true;
        draggedSprite.dragOffsetX = mouseX - sprite.x;
        draggedSprite.dragOffsetY = mouseY - sprite.y;
        isDraggingAny = true;
        canvas.style.cursor = 'grabbing';
      }
    }

    // Mouse/Touch move - přetahování
    function handleMove(e) {
      e.preventDefault();
      const pos = getMousePos(e);
      const lastMouseX = mouseX;
      const lastMouseY = mouseY;
      mouseX = pos.x;
      mouseY = pos.y;

      if (draggedSprite) {
        draggedSprite.x = mouseX - draggedSprite.dragOffsetX;
        draggedSprite.y = mouseY - draggedSprite.dragOffsetY;
        // Uložení rychlosti pro hození
        draggedSprite.lastVelocityX = (mouseX - lastMouseX);
        draggedSprite.lastVelocityY = (mouseY - lastMouseY);
      } else {
        // Změna kurzoru při najetí na sprite
        const sprite = getSpriteAtPosition(mouseX, mouseY);
        canvas.style.cursor = sprite ? 'grab' : 'default';
      }
    }

    // Mouse/Touch end - puštění/hození
    function handleEnd(e) {
      if (draggedSprite) {
        // Nastav rychlosti podle posledního pohybu (fyzika hození)
        const throwMultiplier = 0.5; // Násobitel síly hození
        draggedSprite.speedX = (draggedSprite.lastVelocityX || 0) * throwMultiplier;
        draggedSprite.jumpSpeed = (draggedSprite.lastVelocityY || 0) * throwMultiplier;

        // Přidání rotačního momentu podle horizontální rychlosti
        draggedSprite.rotationSpeed = draggedSprite.speedX * 0.02;

        draggedSprite.isDragging = false;
        draggedSprite.resetPhysics();
        draggedSprite = null;
        isDraggingAny = false;
        canvas.style.cursor = 'default';
      } else if (e.type === 'touchend' || e.type === 'touchcancel') {
        // Kontrola krátkého dotyku pro přidání sprite na mobilu
        const touchDuration = Date.now() - touchStartTime;
        const distance = Math.sqrt(
          Math.pow(mouseX - touchStartPos.x, 2) +
          Math.pow(mouseY - touchStartPos.y, 2)
        );

        // Pokud byl dotyk krátký a bez pohybu, přidej nový sprite
        if (touchDuration < 300 && distance < 20) {
          const randomImage = images[Math.floor(Math.random() * images.length)];
          sprites.push(new Sprite(touchStartPos.x - 25, touchStartPos.y - 25, randomImage));
          updateCount();
        }
      }
    }

    // Event listenery pro myš
    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('mousemove', handleMove);
    canvas.addEventListener('mouseup', handleEnd);
    canvas.addEventListener('mouseleave', handleEnd);

    // Event listenery pro dotyk (mobil/tablet)
    canvas.addEventListener('touchstart', handleStart);
    canvas.addEventListener('touchmove', handleMove);
    canvas.addEventListener('touchend', handleEnd);
    canvas.addEventListener('touchcancel', handleEnd);

    // Přidání nového sprite pravým tlačítkem nebo dlouhým dotekem
    canvas.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      const pos = getMousePos(e);
      const randomImage = images[Math.floor(Math.random() * images.length)];
      sprites.push(new Sprite(pos.x - 50, pos.y - 50, randomImage));
      updateCount();
    });

    // Změna velikosti okna
    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });

    // Přidat podporu pro naklonění telefonu (gyroscope)
    let gyroEnabled = false;
    if (window.DeviceOrientationEvent) {
      window.addEventListener('deviceorientation', (e) => {
        // Aktivuj gyro pouze pokud dostaneme platná data
        if (e.gamma !== null && e.beta !== null) {
          gyroEnabled = true;
          // beta je přední/zadní náklon (-180 to 180)
          // gamma je levý/pravý náklon (-90 to 90)
          const beta = e.beta || 0;   // vertikální náklon
          const gamma = e.gamma || 0; // horizontální náklon

          // Přepočítej gravitaci podle naklonění
          // Omez rozsah a zmenši efekt pro přirozenější pohyb
          gravityX = Math.max(-0.5, Math.min(0.5, gamma / 90 * 0.5));
          gravityY = Math.max(-0.5, Math.min(0.5, (beta - 90) / 90 * 0.5 + 0.3));
        }
      });

      // Tlačítko pro požádání o práva na iOS 13+
      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        const info = document.getElementById('info');
        const btn = document.createElement('button');
        btn.textContent = 'Povolit naklonění';
        btn.style.cssText = 'display:block; margin-top:10px; padding:5px 10px; cursor:pointer;';
        btn.onclick = () => {
          DeviceOrientationEvent.requestPermission()
            .then(response => {
              if (response === 'granted') {
                btn.remove();
              }
            })
            .catch(console.error);
        };
        info.appendChild(btn);
      }
    }
    
    // Service Worker registration for PWA support
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('Service Worker registered successfully:', registration.scope);
          })
          .catch(error => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }
  </script>
</body>

</html>